<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="MACEReports">
<title>Mapping with MACEReports • MACEReports</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Mapping with MACEReports">
<meta property="og:description" content="MACEReports">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">MACEReports</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/MACEReports-mapping.html">Mapping with MACEReports</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Mapping with MACEReports</h1>
            
      
      
      <div class="d-none name"><code>MACEReports-mapping.Rmd</code></div>
    </div>

    
    
<p>MACEReports provides a bunch of functions intended to handle mapping
for cruise reports and presentations. These include:</p>
<ul>
<li>Creating stickplots</li>
<li>Creating interpolated maps</li>
<li>Creating basemaps that use high-resolution bathymetry or simple
contour lines</li>
</ul>
<p>In general, each function is intended to use data that we can readily
query out of the database, and not require a ton of work to prepare and
map it. You should only need to gather Latitude/Longitude (decimal
degrees) and an abundance value (biomass, numbers, etc) in most cases. A
dataframe like that provided here as an example:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Load some packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">MACEReports</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#get a simple dataset to work from: biomass_nmi2 from a single survey</span></span>
<span><span class="va">shelikof_xyz</span> <span class="op">=</span> <span class="va">shelikof_biomass</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2021</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">INTERVAL</span>, <span class="va">START_LATITUDE</span>, <span class="va">START_LONGITUDE</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>BIOMASS <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">BIOMASS</span><span class="op">)</span>,</span>
<span>            BIOMASS_NM2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">BIOMASS_NM2</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">shelikof_xyz</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">INTERVAL</th>
<th align="right">START_LATITUDE</th>
<th align="right">START_LONGITUDE</th>
<th align="right">BIOMASS</th>
<th align="right">BIOMASS_NM2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">2.02103e+13</td>
<td align="right">58.50359</td>
<td align="right">-152.8091</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
</tr>
<tr class="even">
<td align="right">2.02103e+13</td>
<td align="right">58.50873</td>
<td align="right">-152.8212</td>
<td align="right">5896.876</td>
<td align="right">1572.500</td>
</tr>
<tr class="odd">
<td align="right">2.02103e+13</td>
<td align="right">58.51346</td>
<td align="right">-152.8341</td>
<td align="right">56207.647</td>
<td align="right">14988.706</td>
</tr>
<tr class="even">
<td align="right">2.02103e+13</td>
<td align="right">58.51815</td>
<td align="right">-152.8472</td>
<td align="right">36888.068</td>
<td align="right">9836.818</td>
</tr>
<tr class="odd">
<td align="right">2.02103e+13</td>
<td align="right">58.52297</td>
<td align="right">-152.8603</td>
<td align="right">22650.779</td>
<td align="right">6040.208</td>
</tr>
<tr class="even">
<td align="right">2.02103e+13</td>
<td align="right">58.52777</td>
<td align="right">-152.8733</td>
<td align="right">23925.853</td>
<td align="right">6380.227</td>
</tr>
</tbody>
</table>
<p>provides all the values you’ll need for most functions (well,
technically, more: you don’t need the INTERVAL index). Note that this
dataframe has all intervals in the Shelkof present, including those that
have no pollock (i.e. BIOMASS = 0). This is intentional- you’ll want
these if you interpolate values later.</p>
<div class="section level2">
<h2 id="a-note-about-projections">A note about projections<a class="anchor" aria-label="anchor" href="#a-note-about-projections"></a>
</h2>
<p>Although these functions generally require Longitude/Latitude
(decimal degrees; henceforth referred to as x,y) as arguments, they will
re-project points into a nicer projection for producing maps. By
default, this is Albers Equal Area Alaska (EPSG:3338). If you’d prefer
something else, this is possible (see the help for a given
function).</p>
</div>
<div class="section level2">
<h2 id="how-do-i-plot-these-things">How do I plot these things?<a class="anchor" aria-label="anchor" href="#how-do-i-plot-these-things"></a>
</h2>
<p>The functions that create sticks and interpolated plots return data
in forms that can be plotted however you’d like (base R plotting,
ggplot, etc). The Basemaps, however, are ggplot-specific. Examples in
this vignette use ggplot for plotting.</p>
</div>
<div class="section level2">
<h2 id="creating-sticks">Creating sticks<a class="anchor" aria-label="anchor" href="#creating-sticks"></a>
</h2>
<p>To make a stickplot, you’ll need: x,y, and an abundance value (z).
The function <code>build_sf_sticks</code> will return your sticks as a
<code>sf</code> (simple features) dataframe. <code>sf</code> dataframes
can be plotted easily using <code>ggplot2</code>, or base r
<code>plot</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sticks</span> <span class="op">=</span> <span class="fu"><a href="../reference/build_sf_sticks.html">build_sf_sticks</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">shelikof_xyz</span><span class="op">$</span><span class="va">START_LONGITUDE</span>, y <span class="op">=</span> <span class="va">shelikof_xyz</span><span class="op">$</span><span class="va">START_LATITUDE</span>, z <span class="op">=</span> <span class="va">shelikof_xyz</span><span class="op">$</span><span class="va">BIOMASS_NM2</span><span class="op">)</span></span></code></pre></div>
<p>By default, you’ll get a bar that is rotated at 5 degrees from
vertical, and is scaled to work in most plots. These can be specified
differently using the arguments <code>rotation</code> and
<code>bar_scale</code> (see <code><a href="../reference/build_sf_sticks.html">?build_sf_sticks</a></code> for details)
Plotting your sticks is easy with <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">ggplot2::geom_sf()</a></code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">sticks</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="MACEReports-mapping_files/figure-html/stick_demo_2-1.png" width="768"></p>
<p>There is a related function to produce a legend to go with your
sticks, <code>build_stick_legend</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stick_legend</span> <span class="op">=</span> <span class="fu"><a href="../reference/build_stick_legend.html">build_stick_legend</a></span><span class="op">(</span>stick_data <span class="op">=</span> <span class="va">sticks</span><span class="op">)</span></span></code></pre></div>
<p>By default, it produces a white legend to be placed in the bottom
right corner of the plot, with the proper units for our standard plots
of biomss/nmi-2; all of these defaults can be modified as needed (see
<code><a href="../reference/build_stick_legend.html">?build_stick_legend</a></code>). This legend can then be added to you
plot (see below).</p>
</div>
<div class="section level2">
<h2 id="creating-a-basemap">Creating a basemap<a class="anchor" aria-label="anchor" href="#creating-a-basemap"></a>
</h2>
<p>Of course, what we have so far isn’t a great way to look at your
data! We need a basemap. The function <code>get_basemap_layers</code>
returns a background map that uses either a high-resolution bathymetric
layer that’s appropriate for our surveys, or simple contours at
user-specifed depths (i.e. 100 m, 200 m). It can also return a variety
of commonly used layers including the NMFS management areas, 3 NMI
buffer regions,and Steller Sea Lion exclusions. These basemaps are
intended for the Bering Sea and Gulf of Alaska.</p>
<p>If you just want a basic map, you can simply feed the sticks
dataframe you just created to the function
<code>get_basemap_layers</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">basemap</span> <span class="op">=</span> <span class="fu">MACEReports</span><span class="fu">::</span><span class="fu"><a href="../reference/get_basemap_layers.html">get_basemap_layers</a></span><span class="op">(</span>plot_limits_data <span class="op">=</span> <span class="va">sticks</span><span class="op">)</span></span></code></pre></div>
<p>This will produce land and bathymetric layers that encompass your
data. It returns a <code>ggplot</code> object. If you find yourself
wanting to access these layers without using <code>ggplot</code>
plotting- complain, and we’ll add this functionality.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#plot it all: the basemap, the sticks, and the legend:</span></span>
<span><span class="va">basemap</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sticks</span>, color <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="va">stick_legend</span></span></code></pre></div>
<p><img src="MACEReports-mapping_files/figure-html/basic_sticks-1.png" width="768"></p>
</div>
<div class="section level2">
<h2 id="more-stickplot-options">More stickplot options<a class="anchor" aria-label="anchor" href="#more-stickplot-options"></a>
</h2>
<p>We often present stickplots with multiple groups (say, small fish and
big fish) as separate sticks. This can be done with
`build_sf_sticks’:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#summarize the data by fish &gt;=30 cm, &lt;30 cm</span></span>
<span><span class="va">shelikof_by_size</span> <span class="op">=</span> <span class="va">shelikof_biomass</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2021</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>size_class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span> <span class="op">(</span><span class="va">LENGTH</span> <span class="op">&gt;=</span> <span class="fl">30</span>, <span class="st">'big'</span>, <span class="st">'small'</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">INTERVAL</span>, <span class="va">size_class</span>, <span class="va">START_LATITUDE</span>, <span class="va">START_LONGITUDE</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>BIOMASS <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">BIOMASS</span><span class="op">)</span>,</span>
<span>            BIOMASS_NM2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">BIOMASS_NM2</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co">#cleanup: because we included intervals with zero pollock, the size class will be NA in those cases. </span></span>
<span>  <span class="co">#remove those from this plot!</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">size_class</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#use the 'group_variable' argument in build_sf_sticks to build sticks for each group:</span></span>
<span><span class="va">sticks_by_size</span> <span class="op">=</span> <span class="fu"><a href="../reference/build_sf_sticks.html">build_sf_sticks</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">shelikof_by_size</span><span class="op">$</span><span class="va">START_LONGITUDE</span>, y <span class="op">=</span> <span class="va">shelikof_by_size</span><span class="op">$</span><span class="va">START_LATITUDE</span>, z <span class="op">=</span> <span class="va">shelikof_by_size</span><span class="op">$</span><span class="va">BIOMASS_NM2</span>, group_variable <span class="op">=</span> <span class="va">shelikof_by_size</span><span class="op">$</span><span class="va">size_class</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#plot everything again:</span></span>
<span><span class="va">basemap</span> <span class="op">=</span> <span class="fu">MACEReports</span><span class="fu">::</span><span class="fu"><a href="../reference/get_basemap_layers.html">get_basemap_layers</a></span><span class="op">(</span>plot_limits_data <span class="op">=</span> <span class="va">sticks_by_size</span><span class="op">)</span></span>
<span><span class="va">stick_legend</span> <span class="op">=</span> <span class="fu"><a href="../reference/build_stick_legend.html">build_stick_legend</a></span><span class="op">(</span>stick_data <span class="op">=</span> <span class="va">sticks_by_size</span><span class="op">)</span></span>
<span></span>
<span><span class="va">basemap</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sticks_by_size</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">size_class</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="va">stick_legend</span></span></code></pre></div>
<p><img src="MACEReports-mapping_files/figure-html/multiple_groups_sticks-1.png" width="768"></p>
</div>
<div class="section level2">
<h2 id="more-basemap-options">More basemap options<a class="anchor" aria-label="anchor" href="#more-basemap-options"></a>
</h2>
<p>The bathymetry layer is nice for some plots, but inappropriate in
others. Want to keep it simple? Specify what contours you’d like to
draw. Your options are: 50, 100, 200, 300, 500, 700, 1000 (values are in
M).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">basemap</span> <span class="op">=</span> <span class="fu">MACEReports</span><span class="fu">::</span><span class="fu"><a href="../reference/get_basemap_layers.html">get_basemap_layers</a></span><span class="op">(</span>plot_limits_data <span class="op">=</span> <span class="va">sticks_by_size</span>, bathy <span class="op">=</span> <span class="cn">FALSE</span>, contours <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>,<span class="fl">200</span>, <span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#view the plot</span></span>
<span><span class="va">basemap</span></span></code></pre></div>
<p><img src="MACEReports-mapping_files/figure-html/basemap_options_1-1.png" width="768"></p>
<p>You might also want to include a commonly used layer, such as the
NMFS management area or the 3nmi buffer around land areas. Great. See
<code><a href="../reference/get_basemap_layers.html">?get_basemap_layers</a></code> for all the current options, but here’s
how you’d add those ones:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">basemap</span> <span class="op">=</span> <span class="fu">MACEReports</span><span class="fu">::</span><span class="fu"><a href="../reference/get_basemap_layers.html">get_basemap_layers</a></span><span class="op">(</span>plot_limits_data <span class="op">=</span> <span class="va">sticks_by_size</span>, management_regions <span class="op">=</span> <span class="cn">TRUE</span>, alaska_3nmi_buffer <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#view the plot</span></span>
<span><span class="va">basemap</span></span></code></pre></div>
<p><img src="MACEReports-mapping_files/figure-html/basemap_options_2-1.png" width="768"></p>
<p>Since the basemap is just a <code>ggplot</code> object, you can add
anything you might want to it, change the themes, etc.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">basemap</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'Shelikof'</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.border <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="MACEReports-mapping_files/figure-html/basemap_options_3-1.png" width="768"></p>
</div>
<div class="section level2">
<h2 id="interpolations">Interpolations<a class="anchor" aria-label="anchor" href="#interpolations"></a>
</h2>
<p>While the sticks are a MACE favorite, it is often nice to present an
interpolated map as well. Why might you want to do that?</p>
<ul>
<li>Some people think that pseudo 3-d plots like the stickplots are
<strong>bad</strong> (the argument seems to be that they distort the
data and are therefore hard to interpret). I don’t totally agree with
them, but if you agree, interpolated plots are another option to display
distribution and abundance.</li>
<li>Interpolated plots are a nice way to compare distribution and
abundance over time (lots of information in a small panel).</li>
</ul>
<p>Creating interpolations requires you to make a few more choices as
compared to creating stickplots.</p>
<ul>
<li><p>There are limitations on where these plots can be made. Right
now, you can only make maps in the following regions: ‘shelikof’,
‘summer_goa’, ‘core_ebs’, and ‘sca’ (i.e. Shelikof Strait winter survey,
Summer GOA survey, Summer EBS survey, summer EBS survey within the sea
lion conservation area). This is because you must define the domain for
your interpolation. In practical terms, that means someone needs to
build a polygon that defines the domain. If you want to create
interpolations elsewhere, we can work to add that polygon here.</p></li>
<li><p>You have to define the resolution over which you want to
interpolate. Smaller numbers = finer resolution (and slower run times).
This value can be thought of as the distance in meters between the
interpolation points. 1000 seems to work well in the Shelikof, 2500
seems to be fine in the larger regions.</p></li>
<li><p>You have to consider how long you want to wait for an
interpolation. We’ve generally been using universal kriging with
latitude + longitude as predictor variables, i.e. a formula like
<code>log10(abundance) ~ Lat + Long</code>. This works well but can be
very slow! Each estimated point is a function of every observed point-
in a case like the EBS, this can be ~60,000 estimated points, each of
which is estimated on the basis of ~10,000 observations. So it can be
very slow! Therefore, this function includes options that can produce a
similar output that captures the abundance and distribution, but in less
time. We’ve got options for:</p></li>
<li><p>Inverse Distance Weighting</p></li>
<li><p>Ordinary Kriging (with or without a local neighborhood for
estimation, see below)</p></li>
<li><p>Universal kriging (with or without a local neighborhood)</p></li>
</ul>
<p>Using a local neighborhood (i.e. the number of nearest observations
to use in estimation) speeds things up GREATLY and seems to capture the
same trends as estimating without this limitation. Testing suggests that
the best compromise between speed and a helpful presentation of
abundance and distribution is to use universal kriging with a local
neighborhood of 200 observations:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">interp_vals_2021</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_interpolated_plot_vals.html">get_interpolated_plot_vals</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">shelikof_xyz</span><span class="op">$</span><span class="va">START_LONGITUDE</span>, y <span class="op">=</span> <span class="va">shelikof_xyz</span><span class="op">$</span><span class="va">START_LATITUDE</span>, z <span class="op">=</span> <span class="va">shelikof_xyz</span><span class="op">$</span><span class="va">BIOMASS</span>, resolution <span class="op">=</span> <span class="fl">1000</span>, region <span class="op">=</span> <span class="st">'shelikof'</span>, interp_type <span class="op">=</span> <span class="st">'universal'</span>, neighborhood <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Interpolating using universal kridging; this can be very slow! Consider a higher resolution value if this is taking forever (recommended resolution for summer surveys &gt;= 2500; for winter &gt;= 1000"</span></span>
<span></span>
<span><span class="co">#return a small table</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">interp_vals_2021</span><span class="op">)</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">x</th>
<th align="right">y</th>
<th align="right">z</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">18516.69</td>
<td align="right">945095.5</td>
<td align="right">2.674241</td>
</tr>
<tr class="even">
<td align="right">19526.69</td>
<td align="right">945095.5</td>
<td align="right">2.588031</td>
</tr>
<tr class="odd">
<td align="right">20536.69</td>
<td align="right">945095.5</td>
<td align="right">2.435781</td>
</tr>
<tr class="even">
<td align="right">21546.69</td>
<td align="right">945095.5</td>
<td align="right">2.357102</td>
</tr>
<tr class="odd">
<td align="right">22556.69</td>
<td align="right">945095.5</td>
<td align="right">2.310085</td>
</tr>
<tr class="even">
<td align="right">23566.69</td>
<td align="right">945095.5</td>
<td align="right">2.285697</td>
</tr>
</tbody>
</table>
<p>Note that this function simply returns a dataframe with the columns
‘x’, ‘y’, and ‘z’. x and y correspond to the positions of your
interpolated values; z corresponds to the estimated value. By default, x
and y are coordinates in Albers Equal Area projection (but this can be
changed with the <code>out_crs</code> argument to
<code>get_interpolated_plot_vals</code>), while z is the
log10-transformed abundance value (right now, this can’t be changed as
log10-transformed values seem to highlight abundance and distribution
well in our data; this could change in future versions if folks dislike
the chosen transformation).</p>
<p>The x and y points form a grid; therefore, each represents a box of
equal size and should be plotted as a raster.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">interp_vals_2021</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">z</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="MACEReports-mapping_files/figure-html/interpolations_2-1.png" width="768"></p>
<p>Of course, a basemap and a useful color scheme would really help
here. Making a basemap requires one additional step, in comparison to
the above examples with stickplots: because of current limitations in
how some of these functions are written, you must provide an
<code>sf</code> object to the <code>get_basemap_layers</code>
function:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#create an sf object we can use to define the basemap extent</span></span>
<span><span class="va">extent</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">interp_vals_2021</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'x'</span>, <span class="st">'y'</span><span class="op">)</span>, crs <span class="op">=</span> <span class="st">'EPSG:3338'</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#use this to return the basemap; return a simple basemap with contours as the bathymetery seems too busy with interpolated maps</span></span>
<span><span class="va">basemap</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_basemap_layers.html">get_basemap_layers</a></span><span class="op">(</span>plot_limits_data <span class="op">=</span> <span class="va">extent</span>, bathy <span class="op">=</span> <span class="cn">FALSE</span>, contours <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>,<span class="fl">200</span>,<span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Once you’ve got a basemap, you can add your raster (here, with a
slightly upgraded color scheme):</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">basemap</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">interp_vals_2021</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">z</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">'magma'</span><span class="op">)</span></span></code></pre></div>
<p><img src="MACEReports-mapping_files/figure-html/interpolations_4-1.png" width="768"></p>
<p>There is an additional function
<code>get_interpolated_color_bins</code> to bin colors and make trends
easier to see. At a minimum, you have to specify the z value:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">interp_vals_2021</span><span class="op">$</span><span class="va">plot_col</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_interpolated_color_bins.html">get_interpolated_color_bins</a></span><span class="op">(</span>z <span class="op">=</span> <span class="va">interp_vals_2021</span><span class="op">$</span><span class="va">z</span><span class="op">)</span></span>
<span></span>
<span><span class="va">basemap</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">interp_vals_2021</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">plot_col</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_d</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">'magma'</span><span class="op">)</span></span></code></pre></div>
<p><img src="MACEReports-mapping_files/figure-html/interpolations_5-1.png" width="768"></p>
<p>By default, this returns log10-sized bins; this can be modified using
the <code>style</code> argument to
<code>get_interpolated_color_bins</code>. See
<code><a href="../reference/get_interpolated_color_bins.html">?get_interpolated_color_bins</a></code> for options, but
<code>kmeans</code> tends to work well.</p>
<p>If you want to interpolate and compare over multiple years, here’s
one approach:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#summarize example data: biomass per interval, per year</span></span>
<span><span class="va">shelikof_by_year</span> <span class="op">=</span> <span class="va">shelikof_biomass</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">INTERVAL</span>, <span class="va">START_LATITUDE</span>, <span class="va">START_LONGITUDE</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>BIOMASS <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">BIOMASS</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#loop through each year to return each year's values:</span></span>
<span><span class="va">interp_by_year</span> <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">shelikof_by_year</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co">#limit your dataset to one year</span></span>
<span>  <span class="va">tmp_data</span> <span class="op">=</span> <span class="va">shelikof_by_year</span><span class="op">[</span><span class="va">shelikof_by_year</span><span class="op">$</span><span class="va">year</span> <span class="op">==</span> <span class="va">i</span>,<span class="op">]</span></span>
<span>  </span>
<span>  <span class="co">#get the interpolations for this year</span></span>
<span>  <span class="va">interp_vals</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_interpolated_plot_vals.html">get_interpolated_plot_vals</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">tmp_data</span><span class="op">$</span><span class="va">START_LONGITUDE</span>, y <span class="op">=</span> <span class="va">tmp_data</span><span class="op">$</span><span class="va">START_LATITUDE</span>, z <span class="op">=</span> <span class="va">tmp_data</span><span class="op">$</span><span class="va">BIOMASS</span>, resolution <span class="op">=</span> <span class="fl">1000</span>, region <span class="op">=</span> <span class="st">'shelikof'</span>, interp_type <span class="op">=</span> <span class="st">'universal'</span>, neighborhood <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#add a year index</span></span>
<span>  <span class="va">interp_vals</span><span class="op">$</span><span class="va">year</span> <span class="op">=</span> <span class="va">i</span></span>
<span>  </span>
<span>  <span class="co">#and compile</span></span>
<span>  <span class="va">interp_by_year</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">interp_by_year</span>, <span class="va">interp_vals</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] "Interpolating using universal kridging; this can be very slow! Consider a higher resolution value if this is taking forever (recommended resolution for summer surveys &gt;= 2500; for winter &gt;= 1000"</span></span>
<span><span class="co">#&gt; [1] "Interpolating using universal kridging; this can be very slow! Consider a higher resolution value if this is taking forever (recommended resolution for summer surveys &gt;= 2500; for winter &gt;= 1000"</span></span>
<span></span>
<span><span class="co">#create an sf object we can use to define the basemap extent</span></span>
<span><span class="va">extent</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">interp_by_year</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'x'</span>, <span class="st">'y'</span><span class="op">)</span>, crs <span class="op">=</span> <span class="st">'EPSG:3338'</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#use this to return the basemap; return a simple basemap with contours as the bathymetery seems too busy with interpolated maps</span></span>
<span><span class="va">basemap</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_basemap_layers.html">get_basemap_layers</a></span><span class="op">(</span>plot_limits_data <span class="op">=</span> <span class="va">extent</span>, bathy <span class="op">=</span> <span class="cn">FALSE</span>, contours <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>,<span class="fl">200</span>,<span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#bin colors to highlight patterns</span></span>
<span><span class="va">interp_by_year</span><span class="op">$</span><span class="va">plot_col</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_interpolated_color_bins.html">get_interpolated_color_bins</a></span><span class="op">(</span>z <span class="op">=</span> <span class="va">interp_by_year</span><span class="op">$</span><span class="va">z</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#use ggplot to plot, facet plots by year</span></span>
<span><span class="va">basemap</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">interp_by_year</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">plot_col</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_d</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">'magma'</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">year</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">'Biomass (kg)'</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'bottom'</span><span class="op">)</span></span></code></pre></div>
<p><img src="MACEReports-mapping_files/figure-html/compare_multiple_years-1.png" width="768"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Mike Levine.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
